# Сервис сокращения ссылок (Short Links)

Сервис принимает длинные URL и возвращает короткие ссылки с возможностью управления лимитом переходов и временем жизни. Пользователи идентифицируются по UUID без авторизации.

## Требования

- Java 17+
- Maven 3.6+

## Запуск сервиса

```bash
# Linux / macOS
./mvnw spring-boot:run

# Windows
mvnw.cmd spring-boot:run
```

Сервис доступен по адресу: **http://localhost:8080**

- Консоль H2 (БД): http://localhost:8080/h2-console  
- Базовый URL коротких ссылок задаётся в `application.yml` (`shortlinks.base-url`, по умолчанию http://localhost:8080).

---

## API — сводка

| Метод | Путь | Заголовок X-User-Id | Описание |
|-------|------|---------------------|----------|
| POST | /api/links | опционально (если нет — генерируется новый UUID) | Создать короткую ссылку |
| GET | /api/links | обязателен | Список ссылок пользователя |
| GET | /api/links/{id} | обязателен | Получить ссылку по id (только владелец) |
| PUT | /api/links/{id} | обязателен | Обновить ссылку (только владелец) |
| DELETE | /api/links/{id} | обязателен | Удалить ссылку (только владелец) |
| GET | /{shortCode} | **обязателен** (владелец ссылки) | Переход по короткой ссылке → редирект на исходный URL |
| GET | /api/notifications | обязателен | Список уведомлений пользователя |
| PATCH | /api/notifications/{id}/read | обязателен | Отметить уведомление как прочитанное |

---

## Как пользоваться

### 1. Создание короткой ссылки

При **первом** запросе на создание ссылки сервер генерирует **UUID пользователя** и возвращает его в заголовке `X-User-Id` и в теле ответа (`userId`). Этот UUID нужно сохранить и передавать в заголовке `X-User-Id` во всех последующих запросах (переход по ссылке, список ссылок, редактирование, удаление, уведомления).

**Формат тела запроса:** JSON с полями `originalUrl` (обязательно, валидный URL с протоколом `http://` или `https://`) и `clickLimit` (опционально, целое число > 0).

**Пример (curl):**

```bash
# Создание ссылки без лимита переходов
curl -X POST http://localhost:8080/api/links \
  -H "Content-Type: application/json" \
  -d "{\"originalUrl\": \"https://www.baeldung.com/java-9-http-client\"}"

# Ответ: 201 Created, в заголовке X-User-Id — ваш UUID,
# в теле: {"link": {"id", "shortCode", "shortUrl", "originalUrl", "clickLimit", "clicksCount", "expiresAt", "createdAt", "available"}, "userId": "<UUID>"}
```

**С лимитом переходов (например, 5):**

```bash
curl -X POST http://localhost:8080/api/links \
  -H "Content-Type: application/json" \
  -H "X-User-Id: <ваш-UUID>" \
  -d "{\"originalUrl\": \"https://example.com\", \"clickLimit\": 5}"
```

Результат: короткая ссылка вида `http://localhost:8080/<shortCode>`. Разные пользователи получают **разные** короткие ссылки на один и тот же URL.

### 2. Переход по короткой ссылке

Переход по короткой ссылке доступен **только владельцу**: в запросе обязателен заголовок **X-User-Id**, совпадающий с создателем ссылки.

**Коды ответов:**
- **302** — редирект на исходный URL (счётчик переходов увеличивается).
- **400** — отсутствует заголовок X-User-Id.
- **403** — передан X-User-Id другого пользователя (ссылка не принадлежит запрашивающему).
- **404** — ссылка с таким shortCode не найдена.
- **410** — ссылка недоступна (истекла или исчерпан лимит переходов).

**Через curl:**

```bash
curl -v -L -H "X-User-Id: <ваш-UUID>" http://localhost:8080/<shortCode>
```

**Консольный клиент:** при выборе пункта «2» в меню можно ввести короткую ссылку (или только код) — откроется браузер с целевым ресурсом. User-ID подставляется автоматически, если перед этим была создана ссылка (п.1); иначе программа запросит ввод User-ID или можно задать системное свойство `shortlinks.user-id`.

```bash
# Сборка
./mvnw compile   # или mvnw.cmd compile на Windows

# Запуск (сервис должен быть запущен)
java -cp target/classes ru.mephi.ozerov.shortlinks.console.ShortLinkBrowserLauncher

# С другим базовым URL сервиса
java -Dshortlinks.base-url=http://localhost:8080 -cp target/classes ru.mephi.ozerov.shortlinks.console.ShortLinkBrowserLauncher
```

В меню: **1** — создать короткую ссылку (ввод длинного URL), **2** — открыть короткую ссылку в браузере, **0** или **q** — выход.

Сервер при успешном переходе увеличивает счётчик переходов. Если задан лимит и он исчерпан — переход блокируется (410), создаётся уведомление.

### 3. Список своих ссылок

```bash
curl -X GET http://localhost:8080/api/links \
  -H "X-User-Id: <ваш-UUID>"
```

Ответ: JSON-массив объектов ссылок (id, shortCode, shortUrl, originalUrl, clickLimit, clicksCount, expiresAt, createdAt, available).

### 4. Редактирование и удаление ссылок

Редактировать и удалять можно **только свои** ссылки (по UUID).

**Обновить URL и/или лимит переходов:** тело запроса — JSON, оба поля опциональны (`originalUrl`, `clickLimit`). Передаются только те поля, которые нужно изменить.

```bash
curl -X PUT http://localhost:8080/api/links/<id> \
  -H "Content-Type: application/json" \
  -H "X-User-Id: <ваш-UUID>" \
  -d "{\"originalUrl\": \"https://new-url.com\", \"clickLimit\": 10}"
```

**Удалить ссылку:**

```bash
curl -X DELETE http://localhost:8080/api/links/<id> \
  -H "X-User-Id: <ваш-UUID>"
```

Ответ при успехе: **204 No Content**.

### 5. Уведомления

Пользователь получает уведомления, когда:
- лимит переходов по ссылке исчерпан (`CLICK_LIMIT_REACHED`);
- время жизни ссылки истекло — ссылка автоматически удаляется, создаётся уведомление (`LINK_EXPIRED`).

**Получить список уведомлений:**

```bash
curl -X GET http://localhost:8080/api/notifications \
  -H "X-User-Id: <ваш-UUID>"
```

**Отметить уведомление как прочитанное:**

```bash
curl -X PATCH http://localhost:8080/api/notifications/<id>/read \
  -H "X-User-Id: <ваш-UUID>"
```

Ответ при успехе: **204 No Content**.

---

## Соответствие ТЗ

| Требование | Реализация |
|------------|------------|
| Создание коротких ссылок | POST /api/links, ответ с shortUrl и userId |
| Уникальные ссылки для каждого пользователя | Разные userId → разные shortCode при сокращении одного URL |
| Лимит переходов | Поле clickLimit при создании/редактировании; после исчерпания — 410 и уведомление |
| Время жизни задаётся системой | shortlinks.ttl-hours в application.yml (например, 24 часа) |
| Автоматическое удаление истёкших ссылок | Планировщик каждые 10 мин удаляет истёкшие ссылки и создаёт уведомления |
| Уведомления при исчерпании лимита и истечении срока | GET /api/notifications, типы CLICK_LIMIT_REACHED и LINK_EXPIRED |
| Идентификация по UUID | X-User-Id: генерируется при первом POST /api/links |
| Редактирование/удаление только создателем | Проверка userId при PUT/DELETE /api/links/{id} |
| Переход по короткой ссылке только владельцем | GET /{shortCode} с заголовком X-User-Id; проверка владельца, иначе 403 |
| Переход по короткой ссылке в браузере | Консольный клиент ShortLinkBrowserLauncher с Desktop.browse() и X-User-Id |

---

## Тестирование

```bash
./mvnw test
# или на Windows: mvnw.cmd test
```

Проверяется: обязательность X-User-Id для перехода, 403 при чужом User-ID, 404 для неизвестного shortCode, 410 при исчерпании лимита, уведомления, удаление истёкших ссылок, доступ к операциям только для создателя.

---

## Конфигурация

Файл: `src/main/resources/application.yml`

| Свойство | Описание |
|----------|----------|
| `shortlinks.base-url` | Базовый URL коротких ссылок (без завершающего слэша). По умолчанию: http://localhost:8080 |
| `shortlinks.ttl-hours` | Время жизни ссылки в часах (задаётся системой, не пользователем). По умолчанию: 24 |

Для консольного клиента можно задать системные свойства:
- `shortlinks.base-url` — адрес сервиса (если не localhost:8080).
- `shortlinks.user-id` — ваш UUID (если не вводить вручную и не создавать ссылку через п.1).
